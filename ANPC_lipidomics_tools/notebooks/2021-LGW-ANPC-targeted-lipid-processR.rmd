---
title: "ANPC SkylineR and Lipid_exploreR notebook"
output:
  pdf_document: default
  html_document:
    df_print: paged
---
This notebook is designed for use with the ANPC targeted lipid method. 
Section 1: SkylineR is designed to optimise lipidomics data processing in combination with skyline.
Section2: Lipid_exploreR is designed to explore, visualise and QC check the data.

The sections should be run in sequence. However should section 1 already be completed, section 2 can be run independently at a later date.

------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Section 1 - SkylineR

This notebook is designed to optimise lipidomics data processing in combination with skyline.

It will perform:
- retention time optimisation using LTR QC
- peak boundary fitting to all samples

REQUIREMENTS:
- A subfolder containig mzML files. Proteowizard should be used to convert Sciex targeted lipidomics data using proteowizard default settings
- Filename should match the LIMS where possible
- mzML files from LTR samples must have "LTR" in their filename
- A csv template containing the target transition details. ONLY the following column headers should be present: 
      - "Molecule List" (lipid family (e.g. CE))
      - "Precursor Name" (lipid name (e.g. CE(14:0)))
      - "Precursor Mz" (e.g. 614.6)
      - "Precursor Charge" (set as 1)
      - "Product Mz" (e.g. 369.4)
      - "Product Charge" (set as 1)
      - "Explicit Retention Time" (e.g. 11.66)
      - "Explicit Retention Time Window" (leave at 0.5)
      - "Note" in the column "Note" insert the SIL IS to be used for the target lipid. For the rows containing SIL IS themselves leave the note column blank.



```{r, skylineR,  eval = FALSE, echo = FALSE, results = FALSE, warning=FALSE, message=FALSE}
package_list <- c("plyr", "tidyverse", "janitor", "httr")
loaded_packages <- lapply(package_list, require, character.only = TRUE)
rm(loaded_packages)

# Source R script from Github
skylineR_script <- GET(url = "https://raw.githubusercontent.com/lukewhiley/metabolomics_code/main/ANPC_lipidomics_tools/scripts/2021-LGW-lipidomics-skylineR_script.r") %>% content(as = "text")

eval(parse(text = skylineR_script), envir = .GlobalEnv)


```



-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

Section 2 - lipid_exploreR

This notebook is designed to explore the dataset and QC check it. The script generates a report and a final dataset that can be used for data modelling.

```{r, lipid_exploreR,  eval = FALSE, echo = FALSE, results = FALSE, warning=FALSE, message=FALSE}
package_list <- c("plyr", "tidyverse", "janitor", "httr")
loaded_packages <- lapply(package_list, require, character.only = TRUE)
rm(loaded_packages)
#lipidomics_functions_script <- GET(url = "https://raw.githubusercontent.com/lukewhiley/metabolomics_code/main/ANPC_lipidomics_tools/functions/LGW_function_lipidomics_tools.r") %>% content(as = "text")
#eval(parse(text = lipidomics_functions_script), envir = .GlobalEnv)
#rm(lipidomics_functions_script)

# Source R script from Github and prepare data - imports data from section 1. Lipidomics peak picking from skyline
lipid_exploreR_script <- GET(url = "https://raw.githubusercontent.com/lukewhiley/metabolomics_code/main/ANPC_lipidomics_tools/scripts/2021-LGW-lipidomics-lipid_exploreR_script.r") %>% content(as = "text")
eval(parse(text = lipid_exploreR_script), envir = .GlobalEnv)
rm(lipid_exploreR_script)

# SIL check - sums the intensity of all stable isotope labeled internal standards, visualizes the result. If IS have been added correctly should be within x deviations from the median. Allows visualization of outliers
summed_SIL_checkR_script <- GET(url = "https://raw.githubusercontent.com/lukewhiley/metabolomics_code/main/ANPC_lipidomics_tools/scripts/2021-LGW-lipidomics-summed_SIL_checkR_script.r") %>% 
   content(as = "text")
eval(parse(text = summed_SIL_checkR_script), envir = .GlobalEnv)
rm(summed_SIL_checkR_script)

# TIC check - sums the intensity of all target lipids, visualizes the result. If samplehas been added to the well correctly should be within x deviations from the median. Allows visualization of outliers.
summed_TIC_checkR_script <- GET(url = "https://raw.githubusercontent.com/lukewhiley/metabolomics_code/main/ANPC_lipidomics_tools/scripts/2021-LGW-lipidomics-summed_TIC_checkR_script.R") %>% 
   content(as = "text")
eval(parse(text = summed_TIC_checkR_script), envir = .GlobalEnv)
rm(summed_TIC_checkR_script)

#intensity threshold filter

intensity_threshold_checkR_script <- GET(url = "https://raw.githubusercontent.com/lukewhiley/metabolomics_code/main/ANPC_lipidomics_tools/scripts/2021-LGW-lipidomics-intensity_threshold_checkR_script.R") %>% content(as = "text")
  eval(parse(text = intensity_threshold_checkR_script), envir = .GlobalEnv)

# Review individual SIL internal standards 
# Create target lipid to stable isotope ratio internal standard and evaluate them in the pooled QC. Here we use Long Term Reference pool
LTR_SIL_checkR_script <- GET(url = "https://raw.githubusercontent.com/lukewhiley/metabolomics_code/main/ANPC_lipidomics_tools/scripts/2021-LGW-lipidomics-internal_standard_normaliseR.r") %>% 
   content(as = "text")
eval(parse(text = LTR_SIL_checkR_script), envir = .GlobalEnv)
rm(LTR_SIL_checkR_script)

# Produce a PCA to QC data. Allowws for visualization of LTR sample clustering
PCA_QC_script <- GET(url = "https://raw.githubusercontent.com/lukewhiley/metabolomics_code/main/ANPC_lipidomics_tools/scripts/2021-LGW-lipidomics-PCA_QC_checkR_script.r") %>% content(as = "text")
eval(parse(text = PCA_QC_script), envir = .GlobalEnv)
rm(PCA_QC_script)


rmarkdown::render(input = "/Users/lukewhiley/OneDrive - Murdoch University/r_data_analysis/github/metabolomics_code/ANPC_lipidomics_tools/notebooks/2021-LGW-Lipid_ExploreR_QC_Report.Rmd",
                  output_format = "html_document",
                  output_dir = paste(project_dir, "/html_files/", sep=""),
                  output_file = paste(user_name, "_", project_name, "_lipid_exploreR_QC_report.html", sep="")
                  )


dlg_message("Lipidomics pre-processing and QC complete. Thanks for using skylineR and lipid exploreR. TTFN.", type = 'ok')
dlg_message("PS. an official html report can be found in the project folder", type = 'ok')


```

#notes

multiply by concentration factor
report export






