---
title: "SCIEX LIPIDOMICS NOTEBOOK"
output: LIPIDOMICS RESULTS
---

This is an R Notebook designed to help with the processing of lipidomic data generated using the ANPC sciex platform. To run this script you need the following:

1. Create an r-studio project.
  -> open rstudio then click:
    
      File  -> New Project 
              -> New Directory 
                -> New Project 
                  -> browse - navigate to desired location of project 
                    -> type in new project name (e.g. COVID lipidomics)

2. Navigate to the new project in Windows Explorer (or MacOS finder) and set it up with the following files in specific subfolders:
  
      data
      
        -> a folder called "data" containing the following files:
      
        -> File 1:  a ".txt" file containing the metadata. 
                    the filename must contain the text string "sampleDescriptionList"                                 Note - for default ANPC projects this file will be generated by the lims.
      
        -> File 2:  a ".csv" file generated by Skyline MS data processing software using the                          ANPC lipidomics data pre-processing notebook. 
                    The file must contain the text string "export_metabolite_data"
  
      scripts
  
        -> a folder called "scripts" containing the following files:
      
        -> Script 1:  "ANPC_sciex_lipidomics_functions.r" availible from Luke Whiley github. 
                      See Luke for details.
  
  
      plots
  
        -> an empty folder used to store exported plots
      

--------------------------------------------------------------------------------------------------

Notebook Section 1 
Load required packages and functions that are required throughout the notebook

```{r, libraries used,  echo = FALSE, warning=FALSE, message=FALSE}
# libraries

library(plyr)
library(tidyverse)
library(gridExtra)
library(ggpubr)
library(readxl)
library(cowplot)
library(scales)
library(devtools)
library(metabom8)
library(shiny)
library(plotly)
source('scripts/LGW_lipidomics_fuctions.R')



```

################################
Section 2 - USER INPUT REQUIRED
################################

the project name should contain a text string that is in the file names e.g "WA COVID"

```{r, libraries used,  echo = FALSE, warning=FALSE, message=FALSE}

project_name <- "WA COVID"
user_name <- "LGW"


```

###############################
Section 3 - USER INPUT REQUIRED
###############################

Read in the lipid data - see notebook requirements at the top of the document for file requirement specifics

Direct the code chunk to the correct file that you wish to use

```{r, read in data,  echo = FALSE, warning=FALSE, message=FALSE}

# read in master data
master_metabolite_data <- read_csv(file = 'data/2021-02-06_NGW_COVID_WA_export_metabolite_data_ltr_filtered.csv')
master_metadata <- read_delim(file = 'data/sampleDescriptionList.txt', delim = "\t")


```


Section 4
create lists of lipid targets, sample IDs and lipid families

```{r,  echo = FALSE, warning=FALSE, message=FALSE}
sampleID <- master_metabolite_data %>% select(contains(project_name)) %>% colnames() # create list of sample IDs
lipid <- master_metabolite_data$lipid_target # create list of lipid targets
lipid_family <- master_metabolite_data %>% select(lipid_class) %>% unique()

```

Section 5
transpose data and combine with metadata

```{r, echo = FALSE, warning=FALSE, message=FALSE}
metabolite_data <- master_metabolite_data %>% select(contains(project_name)) %>% t() %>% as_tibble(.name_repair = "universal") %>% add_column(sampleID, .before =1)
colnames(metabolite_data) <- c("sampleID", lipid)
#replace sample ID in metabolite data with equivilent from master_metadata to make combining work
for(idx_sID in 1:nrow(master_metadata)){
  sID <- master_metadata$sampleID[idx_sID]
  metabolite_data$sampleID[grep(sID, metabolite_data$sampleID)] <- sID
}

combined_data <- right_join(master_metadata, metabolite_data, by = "sampleID")
```


#####################################################################################
Section X - ONLY FOR COVID WA - FILTER DATA FOR ANALYSIS AND REMOVED UNWANTED SAMPLES
####################################################################################


```{r, match to tryptophan paper,  echo = FALSE, warning=FALSE, message=FALSE}
# this analysis is set up to analyse WA COVID cohort 1. HC vs SARS-CoV-2 (-) vs SARS-CoV-2 (+)

# filter data to match tryptophan paper
analysis_data <- combined_data %>% filter(!is.na(class)) #remove samples from other cohorts that are not in tryptophan paper
analysis_data <- analysis_data %>% filter(class != "Healthy*")
analysis_data <- analysis_data %>% filter(sampleID != "COV00138") %>% filter(sampleID != "COV00157") #remove inconclusive positive sample (JKN?)

#WA COVID ONLY
#TIMEPOINT DATA IS A MESS SO - this section uses the metadata to find the FIRST timepoint available in the samples run (e.g. a sample may have a metadata timepoint of 2,3,4,5, in this instance the ANPC would not have run the true sample 1.) 
#This section will "re-allocate" this time point to an "ANPC timepoint" indexing from 1. e.g. timepoint 2,3,4,5 become 1,2,3,4
anpc_timepoint <- rep(NA, nrow(analysis_data))
analysis_data <- analysis_data %>% add_column(anpc_timepoint, .before = 4) # new column to put a lipid specific timepoint (e.g the earliest timpoint we ran assay on)
unique_rcap <- unique(analysis_data$rcap)

for (idx_tp in 1:length(unique_rcap)){
  first_tp <- (analysis_data %>% filter(rcap == unique_rcap[idx_tp]) %>%  arrange(tpoint) %>% select(sampleID))[1,] %>% paste()
  analysis_data$anpc_timepoint[which(analysis_data$sampleID == first_tp)] <- 1
}

```

#################################################################################################
Section 6 - FILTER DATA FOR TRAINING MODELS - EXAMPLE HERE IS BY TIMEPOINT - USER INPUT REQUIRED
################################################################################################

```{r, filter data,  echo = FALSE, warning=FALSE, message=FALSE}

#SELECT METADATA COLUMN TO FILTER BY. 
#example here is to use the metadata column "anpc_timepoint" and only use timepoint 1

filter_column_1 <- "anpc_timepoint"
filter_value_1 <- 1

#example 2 - filter by specific class - select here the class to keep
filter_column_2 <- "class"
filter_value_2 <- c("Patient (-) SARS-CoV-2","Patient (+) SARS-CoV-2")

print("HAVE YOU COMPLETED THIS SECTION?")

```


Section 6 - create training analysis dataset for both individual lipid species and lipid family data

```{r, filter data,  echo = FALSE, warning=FALSE, message=FALSE}
# create training set data for individual lipid species
training_analysis_data <-  analysis_data %>% 
  filter(!!as.symbol(filter_column_1) == filter_value_1) %>% 
  filter(!!as.symbol(filter_column_2) == filter_value_2[1]|!!as.symbol(filter_column_2) == filter_value_2[2])

# create training set data for summed lipid families
family_data <- create_family_data_summed(training_analysis_data)


family_training_analysis_data <- family_data %>% 
  add_column(training_analysis_data$sampleID, training_analysis_data$class, .before = 1) %>% 
  rename(sampleID = `training_analysis_data$sampleID`, class = `training_analysis_data$class`)
```

##############################################
Section 7 - USER INPUT REQUIRED - PLOT OPTIONS
##############################################

```{r, filter data,  echo = FALSE, warning=FALSE, message=FALSE}

plot_two_group_colours <- c("#999999",  "#56B4E9") #put in plot colors here. This is for 2 class analysis.

plot_three_group_colours <- c("#999999",  "#56B4E9", "black") #put in plot colors here. This is for 3 class analysis.

label_sampleIDs <- FALSE # do you want you sampleIDs labelled on the plots? TRUE/FALSE


```
  
Section 7 - create a PCA for individual lipid species and lipid families

```{r, echo = FALSE, warning=FALSE, message=FALSE, fig.height=6, fig.width=10}

lipids_pca(training_analysis_data)
lipids_pca_plotly(training_analysis_data)

lipids_pca(family_training_analysis_data)
lipids_pca_plotly(family_training_analysis_data)


```



Section 9 - create a OPLS-DA training model

```{r, echo = FALSE, warning=FALSE, message=FALSE, fig.height=6, fig.width=10}
lipids_opls(training_analysis_data)
#lipids_pca_plotly(family_training_analysis_data)
```

```{r, echo = FALSE, warning=FALSE, message=FALSE, fig.height=6, fig.width=10}
lipids_opls()

```





```{r, echo = FALSE, warning=FALSE, message=FALSE, fig.height=6, fig.width=12}
opls_x <-  training_analysis_data %>% select(c(lipid)) %>% as.matrix() 
opls_y <- training_analysis_data %>% select(class) %>% as.matrix()
sampleID <- training_analysis_data %>% select(sampleID)

opls_model <- opls(log10(opls_x+1), opls_y, center = TRUE, scale = "UV")
plot_t_pred <- as.numeric(as.matrix(opls_model@t_pred))
plot_t_orth <- as.numeric(as.matrix(opls_model@t_orth))

#produce OPLS-DA plot
plot_Val <- as_tibble(cbind(plot_t_pred, plot_t_orth))
plot_Val$class <- opls_y[,'class']
plot_Val$sampleID <- sampleID$sampleID

opls_plot <- ggplot() +
  geom_vline(xintercept = 0, colour="black", linetype = "longdash", alpha = 0.4)+
  geom_point(data=plot_Val, aes(x =  plot_t_pred, y =  plot_t_orth, color = class),  size = 6.0)+
  #geom_text(data=plot_Val, aes(x =  plot_t_pred, y =  plot_t_orth, label = sampleID))+
  theme_bw() +
  scale_color_manual(values=plot_two_group_colours)+
  xlab("t_pred")+
  ylab("t_orth")+
  #xlim(c(-5,5))+
  #ylim(c(-8,8))+
  ggtitle("OPLS-DA Sciex Lipidomics Training Model")+
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.title = element_text(size=30)) +
  theme(axis.text.y=element_text(size = 22, margin = margin(t = 0, r = 0, b = 0, l = 2))) +
  theme(axis.text.x=element_text(size = 22)) +
  theme(axis.title = element_text(size = 25)) +
  theme(legend.position = 'none'); opls_plot

#opls_eruption <- eruption(opls_model)


# generate loadings plot -----------------------------------------------

#plotload_cat(opls_model)

```
Section 9 - 


