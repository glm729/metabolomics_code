---
title: "SCIEX LIPIDOMICS NOTEBOOK"
output:
  html_document:
    df_print: paged
---

This is an R Notebook designed to help with the processing of lipidomic data generated using the ANPC sciex platform. To run this script you need the following:

1. Create an r-studio project.
  -> open rstudio then click:
    
      File  -> New Project 
              -> New Directory 
                -> New Project 
                  -> browse - navigate to desired location of project 
                    -> type in new project name (e.g. COVID lipidomics)

2. Navigate to the new project in Windows Explorer (or MacOS finder) and set it up with the following files in specific subfolders:
  
      data
      
        -> a folder called "data" containing the following files:
      
        -> File 1:  a ".txt" file containing the metadata. 
                    the filename must contain the text string "sampleDescriptionList"                                 Note - for default ANPC projects this file will be generated by the lims.
      
        -> File 2:  a ".csv" file generated by Skyline MS data processing software using the                          ANPC lipidomics data pre-processing notebook. 
                    The file must contain the text string "export_metabolite_data"
  
      scripts
  
        -> a folder called "scripts" containing the following files:
      
        -> Script 1:  "ANPC_sciex_lipidomics_functions.r" availible from Luke Whiley github. 
                      See Luke for details.
  
  
      plots
  
        -> an empty folder used to store exported plots
      

--------------------------------------------------------------------------------------------------

Notebook Section 1 
Load required packages and functions that are required throughout the notebook

```{r, libraries used,  echo = FALSE, warning=FALSE, message=FALSE}
# libraries

library(plyr)
library(tidyverse)
library(janitor)
library(gridExtra)
library(ggpubr)
library(readxl)
library(cowplot)
library(scales)
library(devtools)
library(metabom8)
library(shiny)
library(plotly)
library(svDialogs)
library(reactable)
library(DataEditR)

source('scripts/LGW_lipidomics_fuctions.R')



```

################################
Section 2 - USER INPUT REQUIRED
################################

the project name should contain a text string that is in the file names e.g "WA COVID"

```{r, user inputs,  echo = FALSE, warning=FALSE, message=FALSE}

project_name <- dlgInput("what is the name of the project", "example_project")$res
user_name <- dlgInput("Insert your initials", "example_initials")$res

# read in master data
dlg_message("Open metabolite data csv by selecting the CSV generated by the Skyline data processing", type = 'ok')

master_metabolite_data <- read_csv(file = file.choose(.))

dlg_message("Open metabolite metadata by selecting the project SampleDescriptionList.txt generated by the LIMS", type = 'ok')
master_metadata <- read_delim(file = file.choose(.), delim = "\t")

sampleID <- master_metabolite_data %>% select(contains(project_name)) %>% colnames() # create list of sample IDs
lipid <- master_metabolite_data$lipid_target # create list of lipid targets
lipid_family <- master_metabolite_data %>% select(lipid_class) %>% unique()
metabolite_data <- master_metabolite_data %>% select(contains(project_name)) %>% t() %>% as_tibble(.name_repair = "universal") %>% add_column(sampleID, .before =1)
colnames(metabolite_data) <- c("sampleID", lipid)
#replace sample ID in metabolite data with equivilent from master_metadata to make combining work
for(idx_sID in 1:nrow(master_metadata)){
  sID <- master_metadata$sampleID[idx_sID]
  metabolite_data$sampleID[grep(sID, metabolite_data$sampleID)] <- sID
}

combined_data <- right_join(master_metadata, metabolite_data, by = "sampleID") 
analysis_data <- combined_data

```


#####################################################################################
Section X - ONLY FOR COVID WA - FILTER DATA FOR ANALYSIS AND REMOVED UNWANTED SAMPLES
####################################################################################


```{r, match to tryptophan paper,  echo = FALSE, warning=FALSE, message=FALSE}
# this analysis is set up to analyse WA COVID cohort 1. HC vs SARS-CoV-2 (-) vs SARS-CoV-2 (+)

# filter data to match tryptophan paper
analysis_data <- combined_data %>% filter(!is.na(class)) #remove samples from other cohorts that are not in tryptophan paper
analysis_data <- analysis_data %>% filter(class != "Healthy*")
analysis_data <- analysis_data %>% filter(sampleID != "COV00138") %>% filter(sampleID != "COV00157") #remove inconclusive positive sample (JKN?)

#WA COVID ONLY
#TIMEPOINT DATA IS A MESS SO - this section uses the metadata to find the FIRST timepoint available in the samples run (e.g. a sample may have a metadata timepoint of 2,3,4,5, in this instance the ANPC would not have run the true sample 1.) 
#This section will "re-allocate" this time point to an "ANPC timepoint" indexing from 1. e.g. timepoint 2,3,4,5 become 1,2,3,4
anpc_timepoint <- rep(NA, nrow(analysis_data))
analysis_data <- analysis_data %>% add_column(anpc_timepoint, .before = 4) # new column to put a lipid specific timepoint (e.g the earliest timpoint we ran assay on)
unique_rcap <- unique(analysis_data$rcap)

for (idx_tp in 1:length(unique_rcap)){
  first_tp <- (analysis_data %>% filter(rcap == unique_rcap[idx_tp]) %>%  arrange(tpoint) %>% select(sampleID))[1,] %>% paste()
  analysis_data$anpc_timepoint[which(analysis_data$sampleID == first_tp)] <- 1
}

```

#################################################################################################
Section 6 - FILTER DATA FOR TRAINING MODELS - EXAMPLE HERE IS BY TIMEPOINT - USER INPUT REQUIRED
################################################################################################

```{r}
dlg_message("The next step is to prepare the data for the training models", type = 'ok')

filter_terms <- dlgInput("Enter the filter critera seperated by a comma. Remember sampleID is automatically selected.", "example: class, sex, anpc_timepoint")$res %>% strsplit(split = ",") %>% unlist() %>% c() %>% str_replace_all(" ", "")

training_template <- analysis_data %>% select(c("sampleID", all_of(filter_terms))) %>% as.data.frame()
training_template$training <- FALSE

dlg_message("Select the training set samples in the next window. Remeber to press the Sync button before pressing the Done button", type = 'ok')

training_template_edited <- data_edit(training_template,
          viewer = "dialog")
training_template_edited <- training_template_edited %>% filter(training == TRUE) 

#create final training set data from analysis data
training_analysis_data <- analysis_data %>% filter(sampleID %in% training_template_edited$sampleID)

dlg_message("The script will now create lipid family data", type = 'ok') 

# create training set data for summed lipid families
family_data <- create_family_data_summed(training_analysis_data)

family_training_analysis_data <- family_data %>% 
  add_column(select(training_analysis_data, sampleID), select(training_analysis_data, all_of(filter_terms)), .before = 1) 



```

##############################################
Section 7 - USER INPUT REQUIRED - PLOT OPTIONS
##############################################

```{r, plot options,  echo = FALSE, warning=FALSE, message=FALSE}

plot_two_group_colours <- dlgInput("input the colours to be used for a two class plot sepatated by a comma (e.g. healthy vs control)", "example: #999999,  #56B4E9")$res %>%  strsplit(split = ",") %>% unlist() %>% c() %>% str_replace_all(" ", "")

plot_three_group_colours <- dlgInput("input the colours to be used for a three class plot sepatated by a comma (e.g. pos vs neg vs control)", "example: #999999,  #56B4E9, firebrick3")$res %>%  strsplit(split = ",") %>% unlist() %>% c() %>% str_replace_all(" ", "")
  
label_sampleIDs <- dlgInput("Do you want each sample to be labelled with its ID on the plot? TRUE or FALSE", "example: TRUE")$res


```
  
Section 7 - create a PCA for individual lipid species and lipid families

```{r, echo = FALSE, warning=FALSE, message=FALSE, fig.height=6, fig.width=10}

lipids_pca(training_analysis_data)
lipids_pca_plotly(training_analysis_data)

lipids_pca(family_training_analysis_data)
lipids_pca_plotly(family_training_analysis_data)


```



Section 9 - create a OPLS-DA training model

```{r, echo = FALSE, warning=FALSE, message=FALSE, fig.height=6, fig.width=10}
lipids_opls(training_analysis_data)
#lipids_pca_plotly(family_training_analysis_data)
```



